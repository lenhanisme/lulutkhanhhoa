<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>CỨU HỘ KHẨN CẤP | Khánh Hòa - Ninh Thuận</title>
  
  <!-- Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Base Setup */
    body { 
        margin: 0; 
        background: #f8fafc; 
        height: 100vh; 
        height: 100dvh; /* Dynamic Viewport Height for Mobile */
        overflow: hidden; 
        font-family: 'Inter', system-ui, sans-serif; 
        -webkit-tap-highlight-color: transparent;
    }

    /* Safe Area Utilities for iPhone Notch/Home Bar */
    .pt-safe { padding-top: max(12px, env(safe-area-inset-top)); }
    .pb-safe { padding-bottom: max(12px, env(safe-area-inset-bottom)); }
    .top-safe-offset { top: max(160px, calc(140px + env(safe-area-inset-top))); }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Map Layer */
    #map { height: 100% !important; width: 100% !important; z-index: 0; }
    
    /* Glassmorphism Effects */
    .glass-panel { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px); 
        border-top: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }

    /* Custom Pin CSS */
    .pin-icon {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        width: 40px; height: 40px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 3px solid white;
        box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.4);
        display: flex !important;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .pin-inner { transform: rotate(45deg); color: white; font-size: 16px; margin-top: 2px; }
    .leaflet-dragging .pin-icon { transform: rotate(-45deg) scale(1.2) translateY(-10px); cursor: grabbing; }
    
    /* Animations */
    @keyframes pulse-ring {
        0% { transform: scale(0.8); opacity: 0.5; }
        100% { transform: scale(2); opacity: 0; }
    }
    .ring-animate::before {
        content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 100%;
        border-radius: 50%; border: 2px solid #ef4444;
        animation: pulse-ring 2s infinite;
    }
    .animate-blink { animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Transitions for UI Elements */
    .btn-slide-up { transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1), transform 0.1s; }
    .btn-tap:active { transform: scale(0.92) !important; }
    
    /* Input Styling */
    .form-input {
        transition: all 0.2s;
    }
    .form-input:focus {
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
    }
  </style>
</head>
<body class="relative w-full text-slate-800">

  <!-- HEADER (Fixed Z-index high to stay on top) -->
  <header class="absolute top-0 left-0 right-0 z-[50] pointer-events-none px-3 pt-safe lg:p-4">
    <div class="max-w-xl mx-auto w-full">
        <!-- Top Bar -->
        <div class="flex items-center justify-between pointer-events-auto bg-white/90 backdrop-blur-md shadow-lg rounded-2xl p-2 pr-3 border border-white/50 mb-2">
            <a href="/trangchu.html" class="flex items-center gap-3 group">
                <div class="bg-red-600 w-10 h-10 rounded-xl flex items-center justify-center shadow-md group-active:scale-95 transition-transform">
                    <i class="fas fa-location-dot text-white text-lg animate-bounce"></i>
                </div>
                <div class="flex flex-col">
                    <h1 class="text-lg font-black text-slate-800 leading-none tracking-tight">CỨU HỘ 24/7</h1>
                    <p class="text-[11px] font-semibold text-slate-500">Khánh Hòa • Ninh Thuận</p>
                </div>
            </a>
            
            <a href="https://fb.com/lenhanriel" target="_blank" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 active:scale-90 transition-all border border-blue-100">
                <i class="fab fa-facebook-f text-lg"></i>
            </a>
        </div>

        <!-- Filter Buttons -->
        <div class="flex gap-2 overflow-x-auto no-scrollbar pointer-events-auto snap-x py-1 pb-2">
            <button onclick="filterReports('all')" id="btn-all" class="snap-start shrink-0 bg-white/95 backdrop-blur shadow-md px-4 py-2.5 rounded-xl text-xs font-bold text-slate-600 border border-slate-200 active:scale-95 transition-all flex items-center gap-2">
                <i class="fas fa-layer-group text-slate-400"></i> Tất cả 
                <span id="allCount" class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md text-[10px] min-w-[20px]">0</span>
            </button>
            <button onclick="filterReports('victim')" id="btn-victim" class="snap-start shrink-0 bg-red-600 shadow-lg shadow-red-500/30 px-4 py-2.5 rounded-xl text-xs font-bold text-white border border-red-500 active:scale-95 transition-all flex items-center gap-2 ring-2 ring-white/50">
                <i class="fas fa-life-ring animate-pulse"></i> Cần cứu 
                <span id="victimCount" class="bg-white/20 text-white px-1.5 py-0.5 rounded-md text-[10px] min-w-[20px]">0</span>
            </button>
            <button onclick="filterReports('rescue')" id="btn-rescue" class="snap-start shrink-0 bg-blue-600 shadow-lg shadow-blue-500/30 px-4 py-2.5 rounded-xl text-xs font-bold text-white border border-blue-500 active:scale-95 transition-all flex items-center gap-2 ring-2 ring-white/50">
                <i class="fas fa-ship"></i> Đội Cứu Hộ 
                <span id="rescueCount" class="bg-white/20 text-white px-1.5 py-0.5 rounded-md text-[10px] min-w-[20px]">0</span>
            </button>
        </div>
    </div>
  </header>

  <!-- MAP CONTAINER -->
  <div id="map" class="absolute inset-0 bg-slate-200"></div>

  <!-- FLOATING ACTION BUTTONS -->
  <button onclick="getMyLocation()" id="gpsBtn" class="absolute z-40 bottom-[22vh] lg:bottom-32 right-4 lg:right-10 bg-white text-slate-700 w-12 h-12 rounded-2xl shadow-xl shadow-slate-300/50 flex items-center justify-center text-xl transition-all btn-tap border border-white/50 btn-slide-up hover:text-blue-600">
    <i class="fas fa-location-crosshairs"></i>
  </button>

  <button onclick="openReportForm()" id="sendReportBtn" class="absolute z-40 bottom-[12vh] lg:bottom-10 right-4 lg:right-10 bg-gradient-to-br from-red-600 to-red-500 text-white w-16 h-16 rounded-2xl shadow-2xl shadow-red-600/40 flex items-center justify-center text-3xl transition-all btn-tap border-4 border-white ring-animate btn-slide-up hover:rotate-90 duration-500">
    <i class="fas fa-plus"></i>
  </button>

  <!-- INFO PANEL (BOTTOM SHEET) -->
  <!-- Thêm pb-safe để tránh bị Home Bar che -->
  <div id="infoPanel" class="absolute z-30 transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] flex flex-col bottom-0 left-0 w-full h-[18vh] rounded-t-[32px] glass-panel lg:top-28 lg:left-4 lg:bottom-4 lg:w-[400px] lg:h-auto lg:rounded-3xl lg:border lg:border-white/60">
    
    <!-- Drag Handle (Mobile) -->
    <div class="w-full flex justify-center pt-3 pb-1 lg:hidden cursor-pointer active:opacity-50 touch-none" onclick="togglePanel()">
      <div class="w-12 h-1.5 bg-slate-300 rounded-full"></div>
    </div>

    <!-- Scroll Content -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-safe">
      
      <!-- River Level Card -->
      <div class="bg-blue-50/80 backdrop-blur-sm rounded-2xl p-4 border border-blue-100 shadow-sm">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-blue-900 text-xs uppercase tracking-wider flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                Mực nước sông
            </h3>
            <span id="updateTime" class="text-[10px] font-medium text-blue-400 bg-white px-2 py-1 rounded-full shadow-sm">...</span>
        </div>
        <div id="riverLevels" class="grid grid-cols-1 gap-2.5 text-xs">
             <div class="flex items-center justify-center py-2 text-blue-400"><i class="fas fa-circle-notch fa-spin mr-2"></i> Đang tải dữ liệu...</div>
        </div>
      </div>

      <!-- News Feed -->
      <div class="relative">
        <h3 class="font-bold text-slate-800 text-sm mb-3 px-1 flex justify-between items-center sticky top-0 bg-transparent z-10">
            <span class="flex items-center gap-2">
                <i class="fas fa-rss text-red-500"></i> Tin mới nhất
            </span>
            <span class="bg-red-100 text-red-600 px-2.5 py-0.5 rounded-full text-[11px] font-bold shadow-sm" id="victimCountLeft">0</span>
        </h3>
        <div id="reportsList" class="space-y-3 pb-24 lg:pb-0 min-h-[100px]"></div>
      </div>
    </div>
  </div>

  <!-- REPORT MODAL (FORM) -->
  <div id="reportForm" class="hidden fixed inset-0 z-[60] flex items-end justify-center sm:items-center p-0 sm:p-4">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity cursor-pointer" onclick="closeReportForm()"></div>
    
    <!-- Modal Content -->
    <div class="relative bg-white w-full max-w-lg rounded-t-[32px] sm:rounded-3xl p-6 pb-safe shadow-2xl slide-up overflow-hidden">
        <!-- Decoration Header -->
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-red-500 via-orange-500 to-red-500"></div>

        <div class="flex justify-between items-start mb-6 mt-2">
            <div class="w-full pr-4">
                <h2 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                    <span class="text-red-600"><i class="fas fa-bullhorn"></i></span> Gửi Yêu Cầu
                </h2>
                <!-- Location Display -->
                <div class="mt-3 bg-blue-50 rounded-xl p-3 border border-blue-100 flex items-start gap-3">
                    <div class="bg-white p-1.5 rounded-lg shadow-sm text-red-500 flex-shrink-0">
                        <i class="fas fa-map-pin"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] uppercase text-blue-400 font-bold mb-0.5">Vị trí hiện tại</p>
                        <div id="locationAddress" class="text-xs font-semibold text-slate-700 line-clamp-2 leading-relaxed">
                            <span>Đang lấy vị trí...</span>
                        </div>
                        <div id="gpsAccuracy" class="hidden mt-1.5 inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md bg-orange-100 text-orange-700 text-[10px] font-bold">
                            <i class="fas fa-wifi"></i> Sai số <span id="accMeters">0</span>m
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="closeReportForm()" class="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition-colors flex-shrink-0">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Inputs -->
        <div class="space-y-4">
            <div class="relative">
                <textarea id="message" rows="3" class="form-input w-full p-4 pl-12 bg-slate-50 border border-slate-200 rounded-2xl focus:bg-white focus:border-red-500 outline-none text-base font-medium text-slate-800 resize-none placeholder:text-slate-400" placeholder="Mô tả tình trạng (Ngập sâu? Người già/trẻ em?)..."></textarea>
                <div class="absolute left-4 top-4 text-slate-400"><i class="fas fa-comment-dots text-lg"></i></div>
            </div>
            
            <div class="grid grid-cols-5 gap-4">
                <div class="col-span-3 relative">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block">Số điện thoại</label>
                    <div class="relative">
                        <input type="tel" id="phone" placeholder="09xx..." class="form-input w-full p-3.5 pl-11 bg-slate-50 border border-slate-200 rounded-xl focus:border-red-500 outline-none font-bold text-lg text-slate-800 placeholder:font-normal" />
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><i class="fas fa-phone"></i></div>
                    </div>
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1 mb-1 block text-center">Số người</label>
                    <div class="relative flex items-center">
                        <button onclick="document.getElementById('people').stepDown()" class="absolute left-1 w-8 h-8 bg-white rounded-lg text-slate-400 shadow-sm border border-slate-100 active:scale-90 transition"><i class="fas fa-minus text-xs"></i></button>
                        <input type="number" id="people" value="1" min="1" class="form-input w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:border-red-500 outline-none font-bold text-lg text-center text-slate-800" />
                        <button onclick="document.getElementById('people').stepUp()" class="absolute right-1 w-8 h-8 bg-white rounded-lg text-slate-400 shadow-sm border border-slate-100 active:scale-90 transition"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <button id="sendBtn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold text-lg py-4 rounded-2xl shadow-xl shadow-red-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-3 group">
            <span class="group-hover:-translate-y-0.5 transition-transform"><i class="fas fa-paper-plane"></i></span>
            GỬI YÊU CẦU CỨU HỘ
        </button>
        <p class="text-center text-[10px] text-slate-400 mt-3 font-medium mb-4 sm:mb-0">Thông tin sẽ được gửi ngay lập tức tới đội cứu hộ.</p>
        <div class="h-4 sm:h-0"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === VARIABLES ===
    let map, marker, accuracyCircle;
    let lat = 12.24, lng = 109.19; // Default
    let currentAddress = "Chưa xác định";
    let allReports = [];
    
    // DOM ELEMENTS (UNCHANGED IDs)
    const gpsBtn = document.getElementById('gpsBtn');
    const sendReportBtn = document.getElementById('sendReportBtn');
    const infoPanel = document.getElementById('infoPanel');

    // === MAP & GPS LOGIC (UNCHANGED) ===
    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([lat, lng], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

      const pinIcon = L.divIcon({
        className: 'pin-icon',
        html: '<div class="pin-inner"><i class="fas fa-house-chimney"></i></div>',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -45]
      });

      marker = L.marker([lat, lng], {draggable: true, icon: pinIcon}).addTo(map)
        .bindPopup('<div class="text-center font-bold text-sm text-slate-800">Vị trí của bạn<br><span class="text-xs text-red-500 font-semibold">Kéo ghim nếu sai vị trí!</span></div>');
      
      marker.on('dragstart', () => {
        if(accuracyCircle) map.removeLayer(accuracyCircle);
        document.getElementById('gpsAccuracy').classList.add('hidden');
      });

      marker.on('dragend', () => {
        const p = marker.getLatLng();
        lat = p.lat.toFixed(6); lng = p.lng.toFixed(6);
        updateAddressInfo(lat, lng);
      });

      getMyLocation();
    }

    function getMyLocation() {
        if (!navigator.geolocation) return alert("Máy không có GPS hoặc chưa cấp quyền!");
        const btnIcon = document.querySelector('button[onclick="getMyLocation()"] i');
        if(btnIcon) btnIcon.className = "fas fa-spinner fa-spin text-blue-600";

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                lat = pos.coords.latitude; lng = pos.coords.longitude;
                const acc = pos.coords.accuracy;

                map.flyTo([lat, lng], 16, { animate: true, duration: 1.5 });
                marker.setLatLng([lat, lng]);
                
                if (accuracyCircle) map.removeLayer(accuracyCircle);
                accuracyCircle = L.circle([lat, lng], { radius: acc, color: '#3b82f6', fillOpacity: 0.1, weight: 1 }).addTo(map);

                if (acc > 100) {
                    document.getElementById('gpsAccuracy').classList.remove('hidden');
                    document.getElementById('accMeters').textContent = Math.round(acc);
                } else {
                    document.getElementById('gpsAccuracy').classList.add('hidden');
                }

                updateAddressInfo(lat, lng);
                if(btnIcon) btnIcon.className = "fas fa-location-crosshairs text-blue-600";
            },
            (err) => {
                console.warn(err);
                alert("Không lấy được vị trí. Hãy bật GPS và thử lại!");
                if(btnIcon) btnIcon.className = "fas fa-location-crosshairs";
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    }

    async function updateAddressInfo(lat, lng) {
        document.querySelector('#locationAddress span').textContent = "Đang lấy tên đường...";
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            const data = await res.json();
            const addr = data.address || {};
            const parts = [addr.house_number, addr.road, addr.ward, addr.district, addr.city].filter(Boolean);
            currentAddress = parts.join(", ") || "Vị trí đã ghim (Chưa rõ tên đường)";
            
            marker.bindPopup(`<div class="text-center font-bold text-xs p-1 text-slate-700">${currentAddress}</div>`).openPopup();
            document.querySelector('#locationAddress span').textContent = currentAddress;
        } catch {
            currentAddress = "Vị trí đã ghim";
            document.querySelector('#locationAddress span').textContent = currentAddress;
        }
    }

    // === DATA FETCHING & RENDERING ===
    async function loadData() {
        // 1. Load Water Levels
        try {
            const wRes = await fetch('/static/waterdata.json?t=' + Date.now());
            const wData = await wRes.json();
            let wHtml = '';
            (wData.Data || []).forEach(item => {
                const alarm3 = item.AlarmLevel3 || 0;
                const level = parseFloat(item.WaterLevel);
                let cls = "text-slate-600"; 
                let icon = "fa-circle-check text-green-500";
                let bgRow = "bg-white";
                
                if (!isNaN(level) && alarm3 > 0) {
                    if (level > alarm3) { 
                        cls = "text-red-600 font-bold animate-blink"; 
                        icon = "fa-triangle-exclamation text-red-600"; 
                        bgRow = "bg-red-50 border-red-100";
                    } else if (level > alarm3 - 0.5) { 
                        cls = "text-orange-600 font-bold"; 
                        icon = "fa-circle-exclamation text-orange-500"; 
                        bgRow = "bg-orange-50 border-orange-100";
                    }
                }
                wHtml += `
                <div class="flex justify-between items-center ${bgRow} p-2.5 rounded-lg border border-slate-100 shadow-sm transition hover:scale-[1.01]">
                    <div class="flex items-center gap-2.5">
                        <i class="fas ${icon} text-sm"></i>
                        <span class="text-slate-700 font-semibold text-xs tracking-tight">${item.StationName}</span>
                    </div>
                    <div class="${cls} text-sm font-mono">${isNaN(level) ? '--' : level.toFixed(2)}m</div>
                </div>`;
            });
            document.getElementById('riverLevels').innerHTML = wHtml || '<div class="text-center text-xs text-slate-400 py-2">Đang cập nhật dữ liệu...</div>';
            document.getElementById('updateTime').textContent = wData.UpdateTime || '';
        } catch(e) { console.log("Water Err", e); }

        // 2. Load Reports
        try {
            const rRes = await fetch('/api/reports');
            allReports = await rRes.json();
            renderReports('all');
        } catch(e) { console.log("Report Err", e); }
    }

    function renderReports(filterType) {
        const list = document.getElementById('reportsList');
        const victims = allReports.filter(r => r.type === 'victim');
        
        document.getElementById('allCount').textContent = allReports.length;
        document.getElementById('victimCount').textContent = victims.length;
        document.getElementById('victimCountLeft').textContent = victims.length;

        let displayData = allReports;
        if (filterType === 'victim') displayData = victims;
        if (filterType === 'rescue') displayData = allReports.filter(r => r.type === 'rescue');

        if (displayData.length === 0) {
            list.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
                <i class="fas fa-clipboard-check text-2xl mb-2 opacity-50"></i>
                <span class="text-xs font-medium">Chưa có tin mới</span>
            </div>`;
            return;
        }

        list.innerHTML = displayData.map(r => {
            const ggMapLink = `https://www.google.com/maps?q=${r.lat},${r.lng}`;
            
            let cardClass = 'border-blue-500/30 bg-white';
            let iconType = '<div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-info"></i></div>';
            
            if (r.type === 'victim') {
                cardClass = 'border-red-500 bg-red-50/50';
                iconType = '<div class="bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center shadow-sm animate-pulse"><i class="fas fa-exclamation"></i></div>';
            } else if (r.type === 'rescue') {
                cardClass = 'border-blue-600 bg-blue-50/50';
                iconType = '<div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-sm"><i class="fas fa-life-ring"></i></div>';
            }

            return `
            <div class="p-4 rounded-2xl shadow-sm border-l-4 ${cardClass} relative transition hover:shadow-md bg-white mb-2">
                <div class="flex items-start gap-3">
                    ${iconType}
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wide bg-slate-100 px-1.5 py-0.5 rounded">${r.timestamp}</span>
                        </div>
                        <p class="font-bold text-slate-800 text-sm mb-2 break-words leading-snug">${r.message}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            <div class="bg-slate-100 px-2 py-1 rounded-lg text-xs font-medium text-slate-600">
                                <i class="fas fa-user-group text-slate-400 mr-1"></i> ${r.people || 1} người
                            </div>
                            <a href="tel:${r.phone}" class="bg-green-50 px-2 py-1 rounded-lg text-xs font-bold text-green-700 border border-green-100 active:bg-green-100">
                                <i class="fas fa-phone-alt mr-1"></i> ${r.phone || 'SĐT?'}
                            </a>
                        </div>
                    </div>
                </div>

                <a href="${ggMapLink}" target="_blank" class="block w-full text-center bg-slate-50 hover:bg-white border border-slate-200 text-slate-600 hover:text-red-600 hover:border-red-200 font-bold text-xs py-2.5 rounded-xl transition flex items-center justify-center gap-2 mt-1">
                    <i class="fas fa-map-location-dot"></i> Xem bản đồ
                </a>
            </div>`;
        }).join('');
    }

    function filterReports(type) {
        document.querySelectorAll('header button').forEach(b => {
           if(b.id !== 'btn-' + type) {
               b.classList.add('opacity-60', 'scale-95');
               b.classList.remove('ring-2', 'ring-offset-1');
           } else {
               b.classList.remove('opacity-60', 'scale-95');
               b.classList.add('ring-2', 'ring-offset-1');
           }
        });
        renderReports(type);
    }

    // === UI INTERACTIONS (UPDATED FOR IPHONE/MOBILE) ===
    let isPanelExpanded = false;
    
    function togglePanel() {
        isPanelExpanded = !isPanelExpanded;
        
        if (isPanelExpanded) {
            // Expand Panel
            // Dùng top-safe-offset thay vì height để tránh bị header che mất nút kéo
            infoPanel.classList.add('top-safe-offset'); 
            infoPanel.classList.remove('h-[18vh]'); 
            
            // Push buttons up safely
            gpsBtn.style.bottom = 'calc(100vh - 150px)'; 
            sendReportBtn.style.bottom = 'calc(100vh - 220px)';
            gpsBtn.classList.add('opacity-0', 'pointer-events-none'); // Tạm ẩn GPS để đỡ rối
            sendReportBtn.classList.add('opacity-0', 'pointer-events-none'); 

        } else {
            // Collapse Panel
            infoPanel.classList.remove('top-safe-offset');
            infoPanel.classList.add('h-[18vh]'); 

            // Reset buttons
            gpsBtn.style.bottom = '22vh'; 
            sendReportBtn.style.bottom = '12vh'; 
            gpsBtn.classList.remove('opacity-0', 'pointer-events-none');
            sendReportBtn.classList.remove('opacity-0', 'pointer-events-none');
        }
    }

    function openReportForm() { document.getElementById('reportForm').classList.remove('hidden'); }
    function closeReportForm() { document.getElementById('reportForm').classList.add('hidden'); }

    document.getElementById('sendBtn').onclick = async () => {
        const msg = document.getElementById('message').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const people = document.getElementById('people').value || 1;

        if (!msg || !phone) return alert('Vui lòng nhập SĐT và nội dung!');

        const fullMsg = `${msg} \n(Tại: ${currentAddress})`;
        
        const btn = document.getElementById('sendBtn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...'; btn.disabled = true;

        try {
            await fetch('/api/reports', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ lat, lng, message: fullMsg, phone, people, type: 'victim' })
            });
            alert('ĐÃ GỬI CỨU HỘ! Đừng di chuyển, giữ điện thoại liên lạc.');
            closeReportForm();
            loadData();
            document.getElementById('message').value = '';
        } catch(e) { alert('Lỗi kết nối!'); }
        
        btn.innerHTML = originalContent; btn.disabled = false;
    };

    // === START ===
    window.onload = () => {
        initMap();
        loadData();
        setInterval(loadData, 5000);
    };
  </script>
</body>
</html>
