<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CỨU HỘ KHẨN CẤP | Khánh Hòa - Ninh Thuận</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; background: #f3f4f6; height: 100vh; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    #map { height: 100% !important; width: 100% !important; z-index: 0; }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

    /* Custom Pin CSS */
    .pin-icon {
        background-color: #dc2626;
        width: 36px; height: 36px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 3px solid white;
        box-shadow: 3px 3px 10px rgba(0,0,0,0.4);
        display: flex !important;
        align-items: center;
        justify-content: center;
    }
    .pin-inner { transform: rotate(45deg); color: white; font-size: 14px; margin-top: 2px; }
    .leaflet-dragging .pin-icon { transform: rotate(-45deg) scale(1.2) translateY(-10px); transition: all 0.2s ease; }
    
    /* Animation */
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .animate-blink { animation: blink 1s infinite; }
    .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* THAY ĐỔI: CSS cho nút di chuyển theo panel */
    .btn-slide-up { transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
  </style>
</head>
<body class="relative h-screen w-full overflow-hidden text-gray-800">

  <header class="absolute top-0 left-0 right-0 z-30 px-4 py-3 bg-gradient-to-b from-black/60 to-transparent pointer-events-none">
  <div class="flex items-center justify-between pointer-events-auto">
    
    <!-- LOGO CÓ THỂ CLICK -->
    <a href="/trangchu.html" class="flex items-center gap-2 text-white drop-shadow-md">
      <div class="bg-red-600 w-10 h-10 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-location-dot text-xl animate-bounce"></i>
      </div>
      <div class="flex flex-col">
        <h1 class="text-xl font-bold leading-tight">CỨU HỘ</h1>
        <p class="text-[10px] opacity-90 font-medium bg-white/20 px-2 py-0.5 rounded-full inline-block">Khánh Hòa • Ninh Thuận</p>
      </div>
    </a>

    <!-- LINK FACEBOOK -->
    <a href="https://fb.com/lenhanriel" target="_blank" class="bg-white/90 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
      <i class="fab fa-facebook text-xl"></i>
    </a>
  </div>

  <!-- PHẦN FILTER NÚT -->
  <div class="mt-3 flex gap-3 overflow-x-auto no-scrollbar pb-2 pointer-events-auto snap-x">
    <button onclick="filterReports('all')" id="btn-all" class="snap-start flex-shrink-0 bg-white shadow-lg px-4 py-2 rounded-full text-sm font-bold text-gray-700 border border-gray-200 active:scale-95">
      <i class="fas fa-globe text-gray-500"></i> Tất cả <span id="allCount" class="bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded-full text-xs">0</span>
    </button>
    <button onclick="filterReports('victim')" id="btn-victim" class="snap-start flex-shrink-0 bg-red-600 shadow-lg px-4 py-2 rounded-full text-sm font-bold text-white border border-red-700 active:scale-95 ring-2 ring-white">
      <i class="fas fa-heart-crack"></i> Cần cứu <span id="victimCount" class="bg-white text-red-600 px-1.5 py-0.5 rounded-full text-xs">0</span>
    </button>
    <button onclick="filterReports('rescue')" id="btn-rescue" class="snap-start flex-shrink-0 bg-blue-600 shadow-lg px-4 py-2 rounded-full text-sm font-bold text-white border border-blue-700 active:scale-95 ring-2 ring-white">
      <i class="fas fa-sailboat"></i> Đội Cứu Hộ <span id="rescueCount" class="bg-white text-red-600 px-1.5 py-0.5 rounded-full text-xs">0</span>
    </button>
  </div>
</header>
  <div id="map" class="absolute inset-0 bg-gray-200"></div>

  <button onclick="getMyLocation()" id="gpsBtn" class="absolute z-40 bottom-[22vh] lg:bottom-32 right-4 lg:right-10 bg-white text-gray-700 w-12 h-12 rounded-full shadow-xl flex items-center justify-center text-xl transition active:scale-90 border border-gray-200 hover:text-blue-600 btn-slide-up">
    <i class="fas fa-crosshairs"></i>
  </button>

  <button onclick="openReportForm()" id="sendReportBtn" class="absolute z-40 bottom-[12vh] lg:bottom-10 right-4 lg:right-10 bg-red-600 hover:bg-red-700 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-2xl transition active:scale-90 active:rotate-12 border-4 border-white animate-pulse btn-slide-up">
    <i class="fas fa-plus"></i>
  </button>

  <div id="infoPanel" class="absolute z-20 transition-all duration-300 shadow-[0_-5px_20px_rgba(0,0,0,0.15)] flex flex-col bottom-0 left-0 w-full h-[18vh] rounded-t-3xl glass lg:top-24 lg:left-4 lg:bottom-4 lg:w-96 lg:h-auto lg:rounded-2xl lg:bg-white/95">
    
    <div class="w-full flex justify-center pt-3 pb-1 lg:hidden" onclick="togglePanel()">
      <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-4">
      <div class="bg-blue-50 rounded-xl p-3 border border-blue-100 shadow-inner">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-blue-800 text-sm"><i class="fas fa-water mr-1"></i> Mực nước sông</h3>
            <span id="updateTime" class="text-[10px] text-gray-500">...</span>
        </div>
        <div id="riverLevels" class="grid grid-cols-1 gap-2 text-xs">Loading...</div>
      </div>

      <div>
        <h3 class="font-bold text-gray-800 text-sm mb-2 px-1 flex justify-between sticky top-0 bg-white/0 z-10 pb-1">
            <span><i class="fas fa-bullhorn mr-1 text-red-600"></i> Tin mới nhất</span>
            <span class="bg-red-100 text-red-600 px-2 rounded-full text-xs flex items-center" id="victimCountLeft">0</span>
        </h3>
        <div id="reportsList" class="space-y-3 pb-20 lg:pb-0"></div>
      </div>
    </div>
  </div>

  <div id="reportForm" class="hidden fixed inset-0 z-[60] flex items-end justify-center sm:items-center p-0 sm:p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeReportForm()"></div>
    <div class="relative bg-white w-full max-w-lg rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl slide-up">
      
      <div class="flex justify-between items-center mb-4">
        <div class="w-full">
            <h2 class="text-2xl font-bold text-red-600">Gửi Cứu Hộ</h2>
            <div id="locationAddress" class="text-xs text-gray-500 font-medium mt-1 flex items-start gap-1 bg-gray-50 p-2 rounded border border-gray-100">
                <i class="fas fa-map-marker-alt mt-0.5 text-red-500"></i> 
                <span class="line-clamp-2">Đang lấy vị trí...</span>
            </div>
            <div id="gpsAccuracy" class="hidden mt-1 text-[10px] font-bold text-orange-600 flex items-center gap-1">
                <i class="fas fa-exclamation-circle"></i> <span>Sai số <span id="accMeters">0</span>m. Hãy kéo ghim cho chuẩn!</span>
            </div>
        </div>
        <button onclick="closeReportForm()" class="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 ml-2 flex-shrink-0"><i class="fas fa-times"></i></button>
      </div>

      <textarea id="message" rows="3" placeholder="Mô tả: Nước ngập sâu không? Có người già/trẻ em không?..." class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:border-red-500 focus:bg-white outline-none text-base mb-4 resize-none shadow-inner"></textarea>
      
      <div class="grid grid-cols-5 gap-3 mb-6">
        <div class="col-span-3">
            <label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">Số điện thoại</label>
            <input type="tel" id="phone" placeholder="09xx..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-red-500 outline-none font-bold text-lg shadow-sm" />
        </div>
        <div class="col-span-2">
            <label class="text-xs font-bold text-gray-500 ml-1 mb-1 block">Số người</label>
            <input type="number" id="people" value="1" min="1" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-red-500 outline-none font-bold text-lg text-center shadow-sm" />
        </div>
      </div>

      <button id="sendBtn" class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:to-red-700 text-white font-bold text-lg py-4 rounded-xl shadow-lg shadow-red-500/30 active:scale-95 transition flex items-center justify-center gap-2">
        <i class="fas fa-paper-plane"></i> GỬI YÊU CẦU
      </button>
      <div class="h-4 sm:h-0"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === VARIABLES ===
    let map, marker, accuracyCircle;
    let lat = 12.24, lng = 109.19; // Default
    let currentAddress = "Chưa xác định";
    let allReports = [];
    
    // THAY ĐỔI: Khai báo biến DOM cho các nút và panel
    const gpsBtn = document.getElementById('gpsBtn');
    const sendReportBtn = document.getElementById('sendReportBtn');
    const infoPanel = document.getElementById('infoPanel');


    // === MAP & GPS LOGIC ===
    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([lat, lng], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
      L.control.zoom({ position: 'topright' }).addTo(map);

      const pinIcon = L.divIcon({
        className: 'pin-icon',
        html: '<div class="pin-inner"><i class="fas fa-house-chimney"></i></div>',
        iconSize: [36, 36],
        iconAnchor: [18, 36],
        popupAnchor: [0, -40]
      });

      marker = L.marker([lat, lng], {draggable: true, icon: pinIcon}).addTo(map)
        .bindPopup('<div class="text-center font-bold text-sm">Vị trí của bạn<br><span class="text-xs text-gray-500 font-normal">Kéo ghim nếu sai vị trí!</span></div>');
      
      marker.on('dragstart', () => {
        if(accuracyCircle) map.removeLayer(accuracyCircle);
        document.getElementById('gpsAccuracy').classList.add('hidden');
      });

      marker.on('dragend', () => {
        const p = marker.getLatLng();
        lat = p.lat.toFixed(6); lng = p.lng.toFixed(6);
        updateAddressInfo(lat, lng);
      });

      getMyLocation();
    }

    function getMyLocation() {
        if (!navigator.geolocation) return alert("Máy không có GPS hoặc chưa cấp quyền!");
        const btnIcon = document.querySelector('button[onclick="getMyLocation()"] i');
        if(btnIcon) btnIcon.className = "fas fa-spinner fa-spin text-blue-600";

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                lat = pos.coords.latitude; lng = pos.coords.longitude;
                const acc = pos.coords.accuracy;

                map.flyTo([lat, lng], 16, { animate: true, duration: 1.5 });
                marker.setLatLng([lat, lng]);
                
                if (accuracyCircle) map.removeLayer(accuracyCircle);
                accuracyCircle = L.circle([lat, lng], { radius: acc, color: '#3b82f6', fillOpacity: 0.1 }).addTo(map);

                if (acc > 100) {
                    document.getElementById('gpsAccuracy').classList.remove('hidden');
                    document.getElementById('accMeters').textContent = Math.round(acc);
                } else {
                    document.getElementById('gpsAccuracy').classList.add('hidden');
                }

                updateAddressInfo(lat, lng);
                if(btnIcon) btnIcon.className = "fas fa-crosshairs text-blue-600";
            },
            (err) => {
                console.warn(err);
                alert("Không lấy được vị trí. Hãy bật GPS và thử lại!");
                if(btnIcon) btnIcon.className = "fas fa-crosshairs";
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    }

    async function updateAddressInfo(lat, lng) {
        document.querySelector('#locationAddress span').textContent = "Đang lấy tên đường...";
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            const data = await res.json();
            const addr = data.address || {};
            const parts = [addr.house_number, addr.road, addr.ward, addr.district, addr.city].filter(Boolean);
            currentAddress = parts.join(", ") || "Vị trí đã ghim (Chưa rõ tên đường)";
            
            marker.bindPopup(`<div class="text-center font-bold text-xs p-1">${currentAddress}</div>`).openPopup();
            document.querySelector('#locationAddress span').textContent = currentAddress;
        } catch {
            currentAddress = "Vị trí đã ghim";
            document.querySelector('#locationAddress span').textContent = currentAddress;
        }
    }

    // === DATA FETCHING & RENDERING ===
    async function loadData() {
        // 1. Load Water Levels
        try {
            const wRes = await fetch('/static/waterdata.json?t=' + Date.now());
            const wData = await wRes.json();
            let wHtml = '';
            (wData.Data || []).forEach(item => {
                const alarm3 = item.AlarmLevel3 || 0;
                const level = parseFloat(item.WaterLevel);
                let cls = "text-gray-600"; 
                let icon = "fa-check-circle text-green-500";
                
                if (!isNaN(level) && alarm3 > 0) {
                    if (level > alarm3) { 
                        cls = "text-red-600 font-bold animate-blink"; 
                        icon = "fa-exclamation-triangle text-red-600"; 
                    } else if (level > alarm3 - 0.5) { 
                        cls = "text-orange-600 font-bold"; 
                        icon = "fa-exclamation-circle text-orange-500"; 
                    }
                }
                wHtml += `<div class="flex justify-between items-center bg-white p-2 rounded border border-gray-100"><div class="flex items-center gap-2"><i class="fas ${icon} text-xs"></i><span class="text-gray-700 font-medium">${item.StationName}</span></div><div class="${cls}">${isNaN(level) ? '--' : level.toFixed(2)}m</div></div>`;
            });
            document.getElementById('riverLevels').innerHTML = wHtml || '<div class="text-center text-gray-400">Đang cập nhật...</div>';
            document.getElementById('updateTime').textContent = wData.UpdateTime || '';
        } catch(e) { console.log("Water Err", e); }

        // 2. Load Reports
        try {
            const rRes = await fetch('/api/reports');
            allReports = await rRes.json();
            renderReports('all');
        } catch(e) { console.log("Report Err", e); }
    }

    function renderReports(filterType) {
        const list = document.getElementById('reportsList');
        const victims = allReports.filter(r => r.type === 'victim');
        
        // Update counts
        document.getElementById('allCount').textContent = allReports.length;
        document.getElementById('victimCount').textContent = victims.length;
        document.getElementById('victimCountLeft').textContent = victims.length;

        // Filter
        let displayData = allReports;
        if (filterType === 'victim') displayData = victims;
        if (filterType === 'rescue') displayData = allReports.filter(r => r.type === 'rescue');

        if (displayData.length === 0) {
            list.innerHTML = '<div class="text-center py-6 text-gray-400 bg-white/50 rounded-xl border border-dashed border-gray-300">Chưa có tin nào</div>';
            return;
        }

        list.innerHTML = displayData.map(r => {
            const ggMapLink = `https://www.google.com/maps?q=${r.lat},${r.lng}`;
            
            // XỬ LÝ BADGE HIỂN THỊ
            let borderClass = 'border-blue-500 bg-white';
            let badge = '';

            if (r.type === 'victim') {
                borderClass = 'border-red-500 bg-red-50';
                badge = '<span class="bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded animate-pulse">CẤP CỨU</span>';
            } else if (r.type === 'warning') {
                borderClass = 'border-yellow-500 bg-yellow-50';
                badge = '<span class="bg-yellow-600 text-white text-[10px] font-bold px-2 py-1 rounded animate-pulse">THÔNG BÁO KHẨN</span>';
            } else if (r.type === 'rescue') {
                borderClass = 'border-blue-500 bg-blue-50';
                badge = '<span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded">ĐỘI CỨU HỘ</span>';
            }

            return `<div class="p-3 rounded-xl shadow-sm border-l-4 ${borderClass} relative transition hover:shadow-md">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex gap-2 items-center">
                        ${badge}
                        <span class="text-[10px] text-gray-500 font-medium">${r.timestamp}</span>
                    </div>
                </div>
                
                <p class="font-bold text-gray-800 text-sm mb-2 break-words">${r.message}</p>
                
                <div class="flex flex-wrap gap-2 mb-2">
                    <div class="bg-white/80 px-2 py-1 rounded text-xs border border-gray-200">
                        <i class="fas fa-user-group text-gray-500 mr-1"></i> <b>${r.people || 1}</b> người
                    </div>
                    <div class="bg-white/80 px-2 py-1 rounded text-xs border border-gray-200">
                        <i class="fas fa-phone text-gray-500 mr-1"></i> <a href="tel:${r.phone}" class="font-bold text-blue-600">${r.phone || 'SĐT?'}</a>
                    </div>
                </div>

                <a href="${ggMapLink}" target="_blank" class="block w-full text-center bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold text-xs py-2 rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-map-location-dot text-red-500"></i> Mở Google Maps
                </a>
            </div>`;
        }).join('');
    }

    function filterReports(type) {
        document.querySelectorAll('header button').forEach(b => {
            if(b.id !== 'btn-' + type) {
                b.classList.add('opacity-70');
            } else {
                b.classList.remove('opacity-70');
            }
        });
        renderReports(type);
    }

    // === UI INTERACTIONS ===
    let isPanelExpanded = false;
    // THAY ĐỔI: Hàm togglePanel được sửa để điều chỉnh vị trí các nút
    function togglePanel() {
        isPanelExpanded = !isPanelExpanded;
        
        if (isPanelExpanded) {
            // Mở rộng Panel (cao 85vh)
            infoPanel.classList.add('h-[85vh]');
            infoPanel.classList.remove('h-[18vh]'); 
            
            // Đẩy nút lên để cách panel 
            // 85vh (cao panel) + 6vh (lề) = 91vh
            gpsBtn.style.bottom = '91vh'; 
            // 85vh (cao panel) + 1vh (lề) = 86vh, để cách nút GPS 5vh
            sendReportBtn.style.bottom = '80vh'; // Sửa lại thành 80vh để không bị khuất 

        } else {
            // Thu gọn Panel (cao 18vh)
            infoPanel.classList.remove('h-[85vh]');
            infoPanel.classList.add('h-[18vh]'); 

            // Trả nút về vị trí ban đầu
            gpsBtn.style.bottom = '22vh'; 
            sendReportBtn.style.bottom = '12vh'; 
        }
    }


    function openReportForm() { document.getElementById('reportForm').classList.remove('hidden'); }
    function closeReportForm() { document.getElementById('reportForm').classList.add('hidden'); }

    document.getElementById('sendBtn').onclick = async () => {
        const msg = document.getElementById('message').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const people = document.getElementById('people').value || 1;

        if (!msg || !phone) return alert('Vui lòng nhập SĐT và nội dung!');

        // Ghép địa chỉ vào nội dung để hiển thị rõ hơn
        const fullMsg = `${msg} \n(Tại: ${currentAddress})`;
        
        const btn = document.getElementById('sendBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...'; btn.disabled = true;

        try {
            await fetch('/api/reports', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ lat, lng, message: fullMsg, phone, people, type: 'victim' })
            });
            alert('ĐÃ GỬI CỨU HỘ! Đừng di chuyển, giữ điện thoại liên lạc.');
            closeReportForm();
            loadData();
            document.getElementById('message').value = '';
        } catch(e) { alert('Lỗi kết nối!'); }
        
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> GỬI YÊU CẦU'; btn.disabled = false;
    };

    // === START ===
    window.onload = () => {
        initMap();
        loadData();
        setInterval(loadData, 5000); // Cập nhật mỗi 5 giây
    };
  </script>
</body>
</html>
